<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard â€¢ Atendimento</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS -->
    <link rel="stylesheet" href="/static/style.css">

    <!-- Fonte -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <h1>ğŸ“Š Atendimento</h1>
    <p>Mesas em tempo real</p>
</header>

<div class="main-container">

    <!-- =========================
         GERENCIAR MESAS
         ========================= -->
    <section class="gerenciar-mesas">
        <h2>â• Gerenciar Mesas</h2>

        <form action="/mesas/criar" method="post" class="form-mesa">
            <input
                type="number"
                name="numero"
                placeholder="NÃºmero da mesa"
                min="1"
                required
            >
            <button type="submit">Adicionar mesa</button>
        </form>

        <!-- BOTÃƒO QR -->
        <form action="/qrcodes/baixar" method="post" style="margin-top:12px;">
            <button type="submit" style="
                width:100%;
                padding:12px;
                border-radius:10px;
                background:#0ea5e9;
                color:white;
                font-weight:600;
                border:none;
                cursor:pointer;
            ">
                ğŸ“¥ Baixar QR Codes das mesas
            </button>
        </form>
    </section>

    <!-- =========================
         GRID DE MESAS
         ========================= -->
    <div id="mesas">
        {% for numero, info in mesas.items() %}
        <div class="mesa {{ info.status }}" id="mesa-{{ info.id }}">

            <strong>Mesa {{ numero }}</strong>

            <span class="tipo">
                {% if info.tipo == "garcom" %}
                    ğŸ”” Chamando garÃ§om
                {% elif info.tipo == "conta" %}
                    ğŸ’³ Pedindo conta
                {% else %}
                    â€”
                {% endif %}
            </span>

            <span class="status">
                Status: {{ info.status }}
            </span>

            <span class="tempo" data-start="{{ info.timestamp }}"></span>

            <button class="atendido" onclick="atender({{ info.id }})">
                âœ… Atendido
            </button>

            <form action="/mesas/{{ info.id }}/remover" method="post">
                <button type="submit" class="remover">
                    âŒ Remover mesa
                </button>
            </form>

        </div>
        {% endfor %}
    </div>

</div>

<!-- =========================
     ÃUDIO
     ========================= -->
<audio id="alertSound" src="/static/sounds/alert.mp3" preload="auto"></audio>

<!-- =========================
     SCRIPT
     ========================= -->
<script>
    const clienteId = {{ request.session.cliente_id }};
    const protocol = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${protocol}://${location.host}/ws`);

    /* ===== ÃUDIO ===== */
    const alertSound = document.getElementById("alertSound");
    let audioLiberado = false;

    document.addEventListener("click", () => {
        if (!audioLiberado) {
            alertSound.play().then(() => {
                alertSound.pause();
                alertSound.currentTime = 0;
                audioLiberado = true;
                console.log("ğŸ”Š Ãudio liberado");
            }).catch(() => {});
        }
    }, { once: true });

    /* ===== WEBSOCKET ===== */
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        const mesaEl = document.getElementById(`mesa-${data.id}`);
        if (!mesaEl) return;

        mesaEl.className = `mesa ${data.status}`;
        mesaEl.querySelector(".status").innerText = `Status: ${data.status}`;

        const tipoEl = mesaEl.querySelector(".tipo");
        tipoEl.innerText =
            data.tipo === "garcom"
                ? "ğŸ”” Chamando garÃ§om"
                : data.tipo === "conta"
                ? "ğŸ’³ Pedindo conta"
                : "â€”";

        const tempoEl = mesaEl.querySelector(".tempo");
        tempoEl.dataset.start = data.timestamp || "";

        if (audioLiberado && data.status === "chamando") {
            alertSound.play().catch(() => {});
        }
    };

    /* ===== ATENDER ===== */
    function atender(mesaId) {
        fetch(`/c/${clienteId}/mesa/${mesaId}/atendido`, {
            method: "POST"
        });
    }

    /* ===== TEMPO ===== */
    function atualizarTempos() {
        document.querySelectorAll(".tempo").forEach(el => {
            const start = el.dataset.start;

            if (!start || start === "None") {
                el.innerText = "";
                return;
            }

            const diff = Math.floor(Date.now() / 1000 - start);
            const min = Math.floor(diff / 60);
            const sec = diff % 60;

            el.innerText = `â±ï¸ ${min}m ${sec}s`;
        });
    }

    setInterval(atualizarTempos, 1000);
</script>

</body>
</html>
